#!/usr/bin/env python

import helpers
from shutil import copytree
from string import Template
import subprocess
import shutil
import string
import imp
import os
import sys
sys.dont_write_bytecode = True


print "=== Golem C++ Build System ==="
sys.stdout.flush()

project_path = os.path.join(os.getcwd(), 'golem.json')
project_path_alt = os.path.join(os.getcwd(), 'golem.py')
if not os.path.exists(project_path_alt):
    project_path_alt = os.path.join(os.getcwd(), 'project.glm')

if not os.path.exists(project_path) and not os.path.exists(project_path_alt):
    print "ERROR: no project file found ('golem.json' or 'golem.py')"
    sys.exit(1)

if not os.path.exists(project_path):
    module = imp.load_source('__golem_project_glm__', project_path_alt)

golem_path = os.path.abspath(os.path.dirname(os.path.realpath(__file__)))

user_defined_dir = None

for idx, arg in enumerate(sys.argv):
    if arg.startswith('--dir='):
        user_defined_dir = arg.split('=')[1]
        sys.argv[idx] = '--dir=' + os.getcwd()

golem_out = os.path.join('build')
if user_defined_dir:
    golem_out = user_defined_dir

argv = ['python', 'waf/waf-light'] + sys.argv[1:] + \
    ([] if user_defined_dir else ['--dir=' + os.getcwd()])

build_dir = os.path.join(os.getcwd(), golem_out, 'golem')

filein = open(os.path.join(golem_path, 'wscript'))
src = Template(filein.read())
filein.close()
out = src.substitute(builder_path=string.replace(os.path.join(
    golem_path, 'builder.py'), '\\', '\\\\'))

if not os.path.exists(build_dir):
    os.makedirs(build_dir)

fileout = open(os.path.join(build_dir, 'wscript'), 'w+')
fileout.write(out)
fileout.close()

src_waf_dir = os.path.join(golem_path, 'waf')
dst_waf_dir = os.path.join(build_dir, 'waf')
if not os.path.exists(dst_waf_dir):
    copytree(src_waf_dir, dst_waf_dir)

custom_env = os.environ
custom_env['PYTHONPATH'] = golem_path
helpers.run_task(argv, cwd=build_dir, env=custom_env)

if sys.argv[1] == 'distclean':
    path = golem_out
    if sys.platform.startswith('win32'):
        from time import sleep
        while os.path.exists(path):
            os.system("rmdir /s /q %s" % path)
            sleep(0.1)
    else:
        shutil.rmtree(path)
    sys.exit(0)
